name: Maven CI-CD (Build • SonarQube • Nexus • Tomcat)

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build-test-sonar-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'

    - name: Build & Test
      run: mvn -B clean verify

    # SonarQube
    - name: SonarQube Analysis
      run: mvn -B sonar:sonar -Dsonar.login="${{ secrets.SONAR_TOKEN }}" -Dsonar.host.url="http://3.83.229.38:9000"

    # Configure Maven settings
    - name: Configure Maven settings.xml
      run: |
        mkdir -p ~/.m2
        cat > ~/.m2/settings.xml <<EOF
<settings>
  <servers>
    <server>
      <id>JAVA</id>
      <username>${{ secrets.NEXUS_USERNAME }}</username>
      <password>${{ secrets.NEXUS_PASSWORD }}</password>
    </server>
  </servers>
</settings>
EOF

    - name: Deploy to Nexus
      run: mvn -B deploy

    # Deploy to Tomcat
    - name: Deploy WAR to Tomcat
      run: |
        WAR_FILE=$(ls target/*.war | head -n1)
        curl -sS -u "${{ secrets.TOMCAT_USERNAME }}:${{ secrets.TOMCAT_PASSWORD }}" \
          --upload-file "$WAR_FILE" \
          "http://54.242.176.6:8080/manager/text/deploy?path=/JavaWebApp&update=true"
